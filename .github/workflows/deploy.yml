# ========================================
# GitHub Actions 自动部署配置
# ========================================
# 功能：当代码推送到 GitHub 时，自动部署到阿里云服务器
# 作者：AI-site 项目
# 更新时间：2025-01-09
# ========================================

name: Deploy to Aliyun Server

# ========================================
# 触发条件：什么时候执行这个工作流
# ========================================
on:
  push:
    branches:
      - main    # 当推送到 main 分支时触发（如果你的主分支是 main）
      - master  # 或者推送到 master 分支时触发（如果你的主分支是 master）
  # 也可以手动触发（在 GitHub Actions 页面点击 "Run workflow" 按钮）
  workflow_dispatch:

# ========================================
# 定义任务：要执行的具体步骤
# ========================================
jobs:
  deploy:
    # 任务名称（会显示在 GitHub Actions 页面）
    name: 🚀 部署到生产环境
    
    # 运行环境：使用 GitHub 提供的 Ubuntu 虚拟机
    runs-on: ubuntu-latest
    
    # ========================================
    # 具体步骤：按顺序执行
    # ========================================
    steps:
      # ----------------------------------------
      # 步骤 1：检出代码
      # ----------------------------------------
      # 说明：将 GitHub 仓库的代码下载到 GitHub Actions 的虚拟机中
      # 用途：虽然我们不在这里构建，但这一步是标准做法
      - name: 📥 检出代码
        uses: actions/checkout@v3

      # ----------------------------------------
      # 步骤 2：通过 SSH 连接到服务器并执行部署命令
      # ----------------------------------------
      # 说明：使用 appleboy/ssh-action 这个现成的工具连接服务器
      # 文档：https://github.com/appleboy/ssh-action
      - name: 🚀 SSH 连接服务器并部署
        uses: appleboy/ssh-action@master
        with:
          # --- SSH 连接配置 ---
          # 从 GitHub Secrets 中读取敏感信息（不会暴露在日志中）
          host: ${{ secrets.SERVER_HOST }}          # 服务器 IP 地址
          username: ${{ secrets.SERVER_USER }}      # SSH 登录用户名（通常是 root）
          key: ${{ secrets.SERVER_SSH_KEY }}        # SSH 私钥（用于身份验证）
          port: 22                                  # SSH 端口（默认 22，如果改过请修改）
          
          # --- 超时设置 ---
          command_timeout: 10m                      # 命令执行超时时间（10分钟）
          
          # --- 在服务器上执行的命令 ---
          # 说明：下面的命令会在你的服务器上依次执行
          script: |
            echo "========================================="
            echo "🚀 开始部署 AI-site 项目"
            echo "========================================="
            
            # 1. 进入项目目录
            echo "📂 进入项目目录..."
            cd /var/www/ai-site || { echo "❌ 错误：项目目录不存在"; exit 1; }
            
            # 2. 拉取最新代码
            echo "📥 拉取最新代码..."
            git pull origin main || git pull origin master || { echo "❌ 错误：Git 拉取失败"; exit 1; }
            
            # 3. 安装/更新依赖
            echo "📦 安装依赖包..."
            npm install || { echo "❌ 错误：依赖安装失败"; exit 1; }
            
            # 4. 构建生产版本
            echo "🔨 构建生产版本..."
            npm run build || { echo "❌ 错误：构建失败"; exit 1; }
            
            # 5. 重启 PM2 应用（不停机更新）
            echo "🔄 重启应用..."
            pm2 reload ai-site --update-env || pm2 restart ai-site || { echo "❌ 错误：PM2 重启失败"; exit 1; }
            
            # 6. 显示应用状态
            echo "📊 当前应用状态："
            pm2 status ai-site
            
            echo "========================================="
            echo "✅ 部署完成！网站已更新！"
            echo "🌐 访问：https://www.hijarson.com"
            echo "========================================="

      # ----------------------------------------
      # 步骤 3：部署成功后的通知（可选）
      # ----------------------------------------
      # 说明：如果需要，可以在这里添加通知步骤（如钉钉、企业微信、邮件等）
      # 示例已注释，需要时可以启用
      # - name: 📬 发送部署通知
      #   if: success()  # 只有部署成功时才发送
      #   run: |
      #     echo "部署成功，可以在这里添加通知逻辑"
