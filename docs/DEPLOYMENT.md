# ğŸš€ AI-site éƒ¨ç½²æŒ‡å—

## ğŸ“‹ ç›®å½•

- [ç¯å¢ƒé…ç½®](#ç¯å¢ƒé…ç½®)
- [GitHub Secrets é…ç½®](#github-secrets-é…ç½®)
- [æ‰‹åŠ¨éƒ¨ç½²](#æ‰‹åŠ¨éƒ¨ç½²)
- [è‡ªåŠ¨éƒ¨ç½²](#è‡ªåŠ¨éƒ¨ç½²)
- [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)
- [å¸¸ç”¨å‘½ä»¤](#å¸¸ç”¨å‘½ä»¤)

---

## ç¯å¢ƒé…ç½®

### æœåŠ¡å™¨ä¿¡æ¯
- **æœåŠ¡å™¨**: é˜¿é‡Œäº‘ ECS
- **æ“ä½œç³»ç»Ÿ**: CentOS
- **åŸŸå**: www.hijarson.com
- **é¡¹ç›®ç›®å½•**: `/var/www/ai-site`
- **è¿è¡Œç«¯å£**: 3000 (PM2 ç®¡ç†)
- **Nginx ç«¯å£**: 80 (HTTP) / 443 (HTTPS)

### å·²å®‰è£…è½¯ä»¶
- Node.js 18.x (é€šè¿‡ nvm ç®¡ç†)
- npm 10.x
- PM2 (è¿›ç¨‹ç®¡ç†)
- Nginx (åå‘ä»£ç†)
- Git (ç‰ˆæœ¬æ§åˆ¶)

---

## GitHub Secrets é…ç½®

### éœ€è¦é…ç½®çš„ 3 ä¸ª Secrets

åœ¨ GitHub ä»“åº“é¡µé¢ï¼š**Settings** â†’ **Secrets and variables** â†’ **Actions** â†’ **New repository secret**

#### 1. SERVER_HOST (æœåŠ¡å™¨ IP åœ°å€)
- **Name**: `SERVER_HOST`
- **Value**: ä½ çš„æœåŠ¡å™¨å…¬ç½‘ IPï¼ˆå¦‚ `123.45.67.89`ï¼‰
- **è¯´æ˜**: ç”¨äº SSH è¿æ¥æœåŠ¡å™¨

#### 2. SERVER_USER (SSH ç™»å½•ç”¨æˆ·å)
- **Name**: `SERVER_USER`
- **Value**: `root`ï¼ˆæˆ–å…¶ä»–æœ‰æƒé™çš„ç”¨æˆ·ï¼‰
- **è¯´æ˜**: SSH ç™»å½•æ—¶ä½¿ç”¨çš„ç”¨æˆ·å

#### 3. SERVER_SSH_KEY (SSH ç§é’¥)
- **Name**: `SERVER_SSH_KEY`
- **Value**: æœåŠ¡å™¨çš„ SSH ç§é’¥ï¼ˆå®Œæ•´å†…å®¹ï¼‰
- **è·å–æ–¹å¼**:
  ```bash
  # åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
  cat ~/.ssh/id_ed25519
  ```
- **æ³¨æ„**: å¤åˆ¶å®Œæ•´å†…å®¹ï¼ŒåŒ…æ‹¬ `-----BEGIN OPENSSH PRIVATE KEY-----` å’Œ `-----END OPENSSH PRIVATE KEY-----`

---

## æ‰‹åŠ¨éƒ¨ç½²

å¦‚æœéœ€è¦æ‰‹åŠ¨éƒ¨ç½²ï¼ˆä¸ä½¿ç”¨ GitHub Actionsï¼‰ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd /var/www/ai-site

# 2. æ‹‰å–æœ€æ–°ä»£ç 
git pull

# 3. å®‰è£…ä¾èµ–
npm install

# 4. æ„å»ºé¡¹ç›®
npm run build

# 5. é‡å¯åº”ç”¨
pm2 reload ai-site

# 6. æŸ¥çœ‹çŠ¶æ€
pm2 status
pm2 logs ai-site --lines 50
```

---

## è‡ªåŠ¨éƒ¨ç½²

### è§¦å‘æ–¹å¼

è‡ªåŠ¨éƒ¨ç½²ä¼šåœ¨ä»¥ä¸‹æƒ…å†µè§¦å‘ï¼š

1. **è‡ªåŠ¨è§¦å‘**: æ¨é€ä»£ç åˆ° `main` æˆ– `master` åˆ†æ”¯
   ```bash
   git add .
   git commit -m "æ›´æ–°è¯´æ˜"
   git push
   ```

2. **æ‰‹åŠ¨è§¦å‘**: åœ¨ GitHub ç½‘ç«™ä¸Š
   - è¿›å…¥ä»“åº“çš„ **Actions** é¡µé¢
   - é€‰æ‹© **Deploy to Aliyun Server** å·¥ä½œæµ
   - ç‚¹å‡» **Run workflow** æŒ‰é’®

### æŸ¥çœ‹éƒ¨ç½²è¿›åº¦

1. è®¿é—® GitHub ä»“åº“
2. ç‚¹å‡»é¡¶éƒ¨ **Actions** æ ‡ç­¾
3. æŸ¥çœ‹æœ€æ–°çš„å·¥ä½œæµè¿è¡ŒçŠ¶æ€
4. ç‚¹å‡»è¿›å…¥å¯ä»¥çœ‹åˆ°è¯¦ç»†æ—¥å¿—

### éƒ¨ç½²æµç¨‹

```
æœ¬åœ°æ¨é€ä»£ç 
    â†“
GitHub æ¥æ”¶åˆ° push äº‹ä»¶
    â†“
è§¦å‘ GitHub Actions
    â†“
SSH è¿æ¥åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨
    â†“
1. è¿›å…¥é¡¹ç›®ç›®å½•
2. git pull æ‹‰å–æœ€æ–°ä»£ç 
3. npm install å®‰è£…ä¾èµ–
4. npm run build æ„å»ºé¡¹ç›®
5. pm2 reload é‡å¯åº”ç”¨
    â†“
éƒ¨ç½²å®Œæˆ âœ…
```

**é¢„è®¡æ—¶é—´**: 2-3 åˆ†é’Ÿ

---

## æ•…éšœæ’æŸ¥

### 1. GitHub Actions å¤±è´¥

**æŸ¥çœ‹æ—¥å¿—**:
- è¿›å…¥ GitHub Actions é¡µé¢
- ç‚¹å‡»å¤±è´¥çš„å·¥ä½œæµ
- æŸ¥çœ‹çº¢è‰² âŒ çš„æ­¥éª¤

**å¸¸è§é—®é¢˜**:

#### é—®é¢˜ A: SSH è¿æ¥å¤±è´¥
```
Error: Failed to connect to server
```

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ `SERVER_HOST` æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å¼€æ”¾ 22 ç«¯å£
- æ£€æŸ¥ `SERVER_SSH_KEY` æ˜¯å¦å®Œæ•´å¤åˆ¶

#### é—®é¢˜ B: Git pull å¤±è´¥
```
Error: Git æ‹‰å–å¤±è´¥
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ£€æŸ¥ Git çŠ¶æ€
cd /var/www/ai-site
git status

# å¦‚æœæœ‰å†²çªï¼Œé‡ç½®åˆ°è¿œç¨‹ç‰ˆæœ¬
git fetch origin
git reset --hard origin/main
```

#### é—®é¢˜ C: npm install å¤±è´¥
```
Error: ä¾èµ–å®‰è£…å¤±è´¥
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ¸…ç†ç¼“å­˜åé‡æ–°å®‰è£…
cd /var/www/ai-site
rm -rf node_modules package-lock.json
npm cache clean --force
npm install
```

#### é—®é¢˜ D: æ„å»ºå¤±è´¥
```
Error: æ„å»ºå¤±è´¥
```

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥æœ¬åœ°æ˜¯å¦èƒ½æˆåŠŸ `npm run build`
- æŸ¥çœ‹æœåŠ¡å™¨å†…å­˜æ˜¯å¦ä¸è¶³ï¼ˆ`free -h`ï¼‰
- å¦‚æœå†…å­˜ä¸è¶³ï¼Œå¯ä»¥è€ƒè™‘æœ¬åœ°æ„å»ºåä¸Šä¼  `.next` ç›®å½•

#### é—®é¢˜ E: PM2 é‡å¯å¤±è´¥
```
Error: PM2 é‡å¯å¤±è´¥
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æŸ¥çœ‹ PM2 æ—¥å¿—
pm2 logs ai-site --lines 50

# åˆ é™¤å¹¶é‡æ–°å¯åŠ¨
pm2 delete ai-site
pm2 start npm --name "ai-site" -- start
pm2 save
```

---

### 2. ç½‘ç«™è®¿é—®å¼‚å¸¸

#### ç°è±¡ A: 502 Bad Gateway

**åŸå› **: PM2 åº”ç”¨æœªè¿è¡Œ

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥ PM2 çŠ¶æ€
pm2 status

# å¦‚æœ ai-site ä¸åœ¨åˆ—è¡¨ä¸­æˆ–çŠ¶æ€ä¸º stopped
pm2 start npm --name "ai-site" -- start
pm2 save
```

#### ç°è±¡ B: 504 Gateway Timeout

**åŸå› **: åº”ç”¨å¯åŠ¨æ…¢æˆ–å¡æ­»

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
pm2 logs ai-site

# é‡å¯åº”ç”¨
pm2 restart ai-site
```

#### ç°è±¡ C: æ ·å¼ä¸¢å¤±/é¡µé¢ç©ºç™½

**åŸå› **: æ„å»ºäº§ç‰©ä¸å®Œæ•´

**è§£å†³æ–¹æ¡ˆ**:
```bash
cd /var/www/ai-site
rm -rf .next
npm run build
pm2 restart ai-site
```

---

## å¸¸ç”¨å‘½ä»¤

### æœåŠ¡å™¨ç®¡ç†

```bash
# SSH è¿æ¥æœåŠ¡å™¨
ssh root@ä½ çš„æœåŠ¡å™¨IP

# æŸ¥çœ‹ç³»ç»Ÿèµ„æº
free -h        # å†…å­˜ä½¿ç”¨
df -h          # ç£ç›˜ä½¿ç”¨
top            # CPU å’Œè¿›ç¨‹
```

### PM2 ç®¡ç†

```bash
# æŸ¥çœ‹æ‰€æœ‰åº”ç”¨
pm2 list

# æŸ¥çœ‹æŒ‡å®šåº”ç”¨çŠ¶æ€
pm2 status ai-site

# æŸ¥çœ‹æ—¥å¿—
pm2 logs ai-site           # å®æ—¶æ—¥å¿—
pm2 logs ai-site --lines 50  # æœ€è¿‘ 50 è¡Œ

# é‡å¯åº”ç”¨
pm2 restart ai-site        # é‡å¯ï¼ˆä¼šæœ‰çŸ­æš‚åœæœºï¼‰
pm2 reload ai-site         # é‡è½½ï¼ˆ0 åœæœºï¼‰

# åœæ­¢/å¯åŠ¨
pm2 stop ai-site
pm2 start ai-site

# åˆ é™¤åº”ç”¨
pm2 delete ai-site

# ä¿å­˜å½“å‰ PM2 åˆ—è¡¨ï¼ˆå¼€æœºè‡ªå¯ï¼‰
pm2 save

# æ¸…ç©ºæ—¥å¿—
pm2 flush ai-site
```

### Nginx ç®¡ç†

```bash
# æµ‹è¯•é…ç½®
nginx -t

# é‡å¯ Nginx
systemctl restart nginx

# é‡è½½é…ç½®ï¼ˆä¸åœæœºï¼‰
systemctl reload nginx

# æŸ¥çœ‹çŠ¶æ€
systemctl status nginx

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f /var/log/nginx/ai-site-error.log

# æŸ¥çœ‹è®¿é—®æ—¥å¿—
tail -f /var/log/nginx/ai-site-access.log
```

### Git æ“ä½œ

```bash
cd /var/www/ai-site

# æŸ¥çœ‹çŠ¶æ€
git status

# æ‹‰å–æœ€æ–°ä»£ç 
git pull

# æŸ¥çœ‹æäº¤å†å²
git log --oneline -10

# å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
git reset --hard æäº¤hash

# æŸ¥çœ‹è¿œç¨‹åœ°å€
git remote -v
```

### Node.js / npm

```bash
# æŸ¥çœ‹ç‰ˆæœ¬
node --version
npm --version

# æ¸…ç†ç¼“å­˜
npm cache clean --force

# é‡æ–°å®‰è£…ä¾èµ–
rm -rf node_modules
npm install

# æœ¬åœ°æ„å»º
npm run build

# æœ¬åœ°å¯åŠ¨ï¼ˆæµ‹è¯•ç”¨ï¼‰
npm run dev
```

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. å¯ç”¨ Nginx ç¼“å­˜
å·²åœ¨é…ç½®ä¸­å¯ç”¨é™æ€èµ„æºç¼“å­˜ï¼ˆCSSã€JSã€å›¾ç‰‡ç­‰ï¼‰

### 2. é…ç½® CDNï¼ˆå¯é€‰ï¼‰
å¦‚æœè®¿é—®é‡å¤§ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨é˜¿é‡Œäº‘ CDN åŠ é€Ÿé™æ€èµ„æº

### 3. ç›‘æ§å’Œå‘Šè­¦
- é…ç½®é˜¿é‡Œäº‘ç›‘æ§å‘Šè­¦ï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ï¼‰
- ä½¿ç”¨ PM2 Plusï¼ˆå¯é€‰ï¼‰è¿›è¡Œåº”ç”¨ç›‘æ§

### 4. å®šæœŸå¤‡ä»½
```bash
# å¤‡ä»½è„šæœ¬ç¤ºä¾‹
#!/bin/bash
DATE=$(date +%Y%m%d)
tar -czf /backup/ai-site-$DATE.tar.gz /var/www/ai-site
```

---

## å®‰å…¨å»ºè®®

1. **å®šæœŸæ›´æ–°ç³»ç»Ÿå’Œè½¯ä»¶åŒ…**
   ```bash
   yum update -y
   ```

2. **é…ç½®é˜²ç«å¢™**
   - åªå¼€æ”¾å¿…è¦ç«¯å£ï¼ˆ80ã€443ã€22ï¼‰
   - è€ƒè™‘ä¿®æ”¹ SSH é»˜è®¤ç«¯å£ï¼ˆ22 æ”¹ä¸ºå…¶ä»–ï¼‰

3. **ä½¿ç”¨é root ç”¨æˆ·**
   - åˆ›å»ºä¸“é—¨çš„éƒ¨ç½²ç”¨æˆ·
   - é…ç½® sudo æƒé™

4. **å®šæœŸæ£€æŸ¥æ—¥å¿—**
   - Nginx è®¿é—®æ—¥å¿—ï¼ˆå¼‚å¸¸æµé‡ï¼‰
   - åº”ç”¨æ—¥å¿—ï¼ˆé”™è¯¯ä¿¡æ¯ï¼‰

---

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»é¡¹ç›®ç»´æŠ¤è€…æˆ–æŸ¥çœ‹ï¼š
- GitHub Issues: https://github.com/caixiongjiang/AI-site/issues
- é¡¹ç›®æ–‡æ¡£: README.md

---

**æœ€åæ›´æ–°**: 2025-01-09
